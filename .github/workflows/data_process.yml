name: Stage 2 - Data Processing

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Stage 1 - Data Download"]
    types:
      - completed

concurrency:
  group: stage2-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "scripts/uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: cd scripts && uv sync --frozen

      - name: Calculate cache key (weekly rotation)
        id: cache-key
        run: |
          WEEK=$(date +'%Y-W%V')
          DAYS="${INSPECTION_DAYS_LIMIT:-all}"
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "days=$DAYS" >> $GITHUB_OUTPUT
        env:
          INSPECTION_DAYS_LIMIT: ${{ vars.INSPECTION_DAYS_LIMIT }}

      - name: Download raw data artifact (from workflow_run)
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: raw-data
          path: data/raw
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore raw data from cache (workflow_dispatch fallback)
        if: github.event_name == 'workflow_dispatch'
        run: |
          mkdir -p data/raw
          echo "Restoring datasets from individual caches..."

      - name: Restore gekentekende_voertuigen cache
        if: github.event_name == 'workflow_dispatch'
        uses: actions/cache/restore@v4
        with:
          path: data/raw/gekentekende_voertuigen.json
          key: gekentekende_voertuigen-v2-${{ steps.cache-key.outputs.week }}-days-${{ steps.cache-key.outputs.days }}

      - name: Restore meldingen_keuringsinstantie cache
        if: github.event_name == 'workflow_dispatch'
        uses: actions/cache/restore@v4
        with:
          path: data/raw/meldingen_keuringsinstantie.json
          key: meldingen_keuringsinstantie-v2-${{ steps.cache-key.outputs.week }}-days-${{ steps.cache-key.outputs.days }}

      - name: Restore geconstateerde_gebreken cache
        if: github.event_name == 'workflow_dispatch'
        uses: actions/cache/restore@v4
        with:
          path: data/raw/geconstateerde_gebreken.json
          key: geconstateerde_gebreken-v2-${{ steps.cache-key.outputs.week }}-days-${{ steps.cache-key.outputs.days }}

      - name: Restore gebreken cache
        if: github.event_name == 'workflow_dispatch'
        uses: actions/cache/restore@v4
        with:
          path: data/raw/gebreken.json
          key: gebreken-v2-${{ steps.cache-key.outputs.week }}

      - name: Restore brandstof cache
        if: github.event_name == 'workflow_dispatch'
        uses: actions/cache/restore@v4
        with:
          path: data/raw/brandstof.json
          key: brandstof-v2-${{ steps.cache-key.outputs.week }}

      - name: Verify raw data
        run: |
          echo "Checking raw data files:"
          ls -lh data/raw/ || echo "No files in data/raw"
          for f in gekentekende_voertuigen meldingen_keuringsinstantie geconstateerde_gebreken gebreken brandstof; do
            if [ ! -f "data/raw/${f}.json" ]; then
              echo "ERROR: Missing ${f}.json"
              exit 1
            fi
          done
          echo "All datasets present"

      - name: Run data processing script
        run: cd scripts && uv run python data_process.py

      - name: Upload processed data artifact
        uses: actions/upload-artifact@v4
        with:
          name: processed-data
          path: data/processed
          retention-days: 7
