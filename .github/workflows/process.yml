name: Process Data

on:
  # Trigger after download workflow completes
  workflow_run:
    workflows: ["Download Data"]
    types:
      - completed
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  actions: read

# Allow only one concurrent process
concurrency:
  group: "process"
  cancel-in-progress: false

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run if download succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Download data artifact from download workflow
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: all-data
          path: data
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: Download data artifact (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: download.yml
          name: all-data
          path: data
          search_artifacts: true
      
      - name: Verify data files
        run: |
          for f in inspections vehicles fuel defects_found defect_codes; do
            if [ ! -f "data/${f}.csv" ]; then
              echo "ERROR: Missing data/${f}.csv"
              exit 1
            fi
            echo "OK: data/${f}.csv ($(wc -l < data/${f}.csv) lines)"
          done
      
      - name: Process data
        run: python src/process_data.py
      
      - name: Verify output files
        run: |
          for f in brand_reliability model_reliability; do
            if [ ! -f "site/data/${f}.json" ]; then
              echo "ERROR: Missing site/data/${f}.json"
              exit 1
            fi
            echo "OK: site/data/${f}.json"
          done
      
      - name: Upload processed data artifact
        uses: actions/upload-artifact@v4
        with:
          name: processed-data
          path: |
            site/data/brand_reliability.json
            site/data/model_reliability.json
          retention-days: 1
      
      - name: Process summary
        run: |
          echo "### Process Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          for f in site/data/*.json; do
            name=$(basename "$f")
            size=$(du -h "$f" | cut -f1)
            echo "| ${name} | ${size} |" >> $GITHUB_STEP_SUMMARY
          done
